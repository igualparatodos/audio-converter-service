name: CI (Kubernetes)

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  ECR_REPO: production-audio-converter
  ARGOCD_APP_NAME: audio-converter
  AWS_ACCOUNT_ID: "992382838579"
  AWS_REGION: "sa-east-1"
  ARGOCD_SERVER_URL: "argocd.igual.cloud"

jobs:
  build:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:latest
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to ArgoCD
    needs: [build]
    runs-on: ubuntu-latest
    env:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJjaS1ib3Q6YXBpS2V5IiwiZXhwIjoxNzk0NTcwOTM1LCJuYmYiOjE3NjMwMzQ5MzUsImlhdCI6MTc2MzAzNDkzNSwianRpIjoiY2ktYm90LWNpIn0.kKrRtB5cgbLtp6aKFVKL9y_HSX8hUfIpXlJHlc_nIoY' }}
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v2.6.15/argocd-linux-amd64
          sudo install -m 755 /tmp/argocd /usr/local/bin/argocd
          argocd version --client

      - name: Update Image Tag in ArgoCD
        run: |
          argocd app set ${{ env.ARGOCD_APP_NAME }} \
            --server ${{ env.ARGOCD_SERVER_URL }} \
            --parameter igual-application-chart.image.tag=${{ github.sha }} \
            --grpc-web

          echo "Waiting for ArgoCD to complete parameter update..."
          argocd app wait ${{ env.ARGOCD_APP_NAME }} \
            --server ${{ env.ARGOCD_SERVER_URL }} \
            --operation \
            --timeout 60 \
            --grpc-web || echo "No operation in progress or wait timed out"

      - name: Sync ArgoCD Application
        run: |
          argocd app get ${{ env.ARGOCD_APP_NAME }} \
            --server ${{ env.ARGOCD_SERVER_URL }} \
            --refresh \
            --grpc-web

          argocd app sync ${{ env.ARGOCD_APP_NAME }} \
            --server ${{ env.ARGOCD_SERVER_URL }} \
            --force \
            --prune \
            --retry-limit 3 \
            --grpc-web \
            --async || echo "Sync triggered or already in progress"

      - name: Wait for Sync
        run: |
          echo "Waiting for application to sync..."
          for i in {1..60}; do
            APP_STATUS=$(argocd app get ${{ env.ARGOCD_APP_NAME }} \
              --server ${{ env.ARGOCD_SERVER_URL }} \
              --grpc-web \
              --output json 2>/dev/null || echo "{}")

            SYNC_STATUS=$(echo "$APP_STATUS" | jq -r '.status.sync.status // "Unknown"')
            HEALTH_STATUS=$(echo "$APP_STATUS" | jq -r '.status.health.status // "Unknown"')

            echo "[$i/60] Sync: $SYNC_STATUS | Health: $HEALTH_STATUS"

            if [ "$SYNC_STATUS" = "Synced" ] && [ "$HEALTH_STATUS" = "Healthy" ]; then
              echo "✅ Application is synced and healthy!"
              exit 0
            fi

            if [ "$HEALTH_STATUS" = "Degraded" ]; then
              echo "❌ Application is degraded!"
              exit 1
            fi

            sleep 5
          done

          echo "⏱️ Timeout waiting for sync"
          exit 1